  try {
    let imageData: string;
    
    // Check if imageBase64 is a URL or a base64 string
    if (imageBase64.startsWith('http')) {
      // If it's a URL, we can still process it with the Gemini 1.5 Flash multimodal model
      // by sending the URL directly in the prompt
      console.log("Using image URL directly with Gemini 1.5 multimodal capabilities");
      
      // Create a multimodal request that includes the image URL and product name
      const textResult = await geminiProVision.generateContent([
        {
          text: `Analyze this product (image URL: ${imageBase64}) and provide the following details formatted as JSON for a South African e-commerce store:
          1. "description": A detailed product description (max 100 words) that includes materials, features, and benefits
          2. "category": A single likely product category (e.g., Bedding, Home Decor, Kitchen, etc.)
          3. "brand": A likely brand name based on product type
          4. "tags": An array of 5-7 relevant tags (each 1-3 words)
          5. "costPrice": Estimated wholesale/cost price in South African Rand (ZAR)
          6. "price": Suggested retail price in South African Rand (ZAR) with appropriate markup
          7. "marketResearch": A brief summary of current market prices for similar products in South Africa (3-4 sentences)
          
          The product name is: "${productName}"
          
          Important: Research current market prices for similar products in South Africa to provide realistic price estimates.
          Specifically look at what similar products cost in South African stores like Mr Price Home, Woolworths, @Home, and Takealot.
          
          Format the response as valid JSON only, with no additional text.`
        }
      ]);
      
      const textResponse = await textResult.response;
      const responseText = textResponse.text();
      
      try {
        const jsonResponse = JSON.parse(responseText);
        return {
          suggestedName: productName, // Use the provided product name
          suggestedDescription: jsonResponse.description,
          suggestedCategory: jsonResponse.category,
          suggestedBrand: jsonResponse.brand,
          suggestedTags: jsonResponse.tags,
          suggestedCostPrice: jsonResponse.costPrice ? Number(jsonResponse.costPrice) : undefined,
          suggestedPrice: jsonResponse.price ? Number(jsonResponse.price) : undefined
        };
      } catch (jsonError) {
        console.error('Failed to parse text-only JSON response:', jsonError);
        return {
          suggestedName: productName,
          suggestedDescription: "",
          suggestedCategory: "",
          suggestedBrand: "",
          suggestedTags: []
        };
      }
    }
    
    try {
      // Extract content type and convert to buffer
      const imageBuffer = base64ToBuffer(imageBase64);
      
      // Resize image to reduce processing time and convert to PNG format
      const resizedImageBuffer = await sharp(imageBuffer)
        .resize({ width: 512, height: 512, fit: 'inside' })
        .png() // Convert to PNG format for consistency
        .toBuffer();
      
      // Create prompt
      imageData = bufferToBase64(resizedImageBuffer, 'image/png');
    } catch (imageError) {
      console.warn('Image processing failed:', imageError);
      
      // If image processing fails, fall back to text-only analysis using the product name
      console.log("Falling back to text-only analysis due to image processing failure");
      
      // Create a text-only request using Gemini 1.5 Flash's multimodal capabilities
      const textResult = await geminiProVision.generateContent([
        {
          text: `Analyze this product and provide the following details formatted as JSON for a South African e-commerce store:
          1. "description": A detailed product description (max 100 words) including materials, features, and benefits
          2. "category": A single likely product category (e.g., Bedding, Home Decor, Kitchen, etc.)
          3. "brand": A likely brand name based on product type
          4. "tags": An array of 5-7 relevant tags (each 1-3 words)
          5. "costPrice": Estimated wholesale/cost price in South African Rand (ZAR)
          6. "price": Suggested retail price in South African Rand (ZAR) with appropriate markup
          7. "marketResearch": Brief summary of current market prices for similar products in South Africa (3-4 sentences)
          
          The product name is: "${productName}"
          
          Important: Research current market prices for similar products in South Africa to provide realistic price estimates.
          Specifically look at what similar products cost in South African stores like Mr Price Home, Woolworths, @Home, and Takealot.
          
          Format the response as valid JSON only, with no additional text.`
        }
      ]);
      
      try {
        const textResponse = await textResult.response;
        const responseText = textResponse.text();
        
        const jsonResponse = JSON.parse(responseText);
        return {
          suggestedName: productName,
          suggestedDescription: jsonResponse.description || "",
          suggestedCategory: jsonResponse.category || "",
          suggestedBrand: jsonResponse.brand || "",
          suggestedTags: jsonResponse.tags || [],
          suggestedCostPrice: jsonResponse.costPrice ? Number(jsonResponse.costPrice) : undefined,
          suggestedPrice: jsonResponse.price ? Number(jsonResponse.price) : undefined
        };
      } catch (jsonError) {
        console.error('Failed to parse text-only JSON response:', jsonError);
        // If all else fails, return just the product name as a fallback
        return {
          suggestedName: productName,
          suggestedDescription: "",
          suggestedCategory: "",
          suggestedBrand: "",
          suggestedTags: []
        };
      }
    }
    
    // Create the generation request using multimodal capabilities of Gemini 1.5
    // This will analyze both the image and the text (product name)
    const result = await geminiProVision.generateContent([
      {
        text: `Analyze this product image and provide the following details formatted as JSON for a South African e-commerce store:
        1. "name": A concise product name (max 10 words) - note that the user provided the name "${productName}"
        2. "description": A detailed product description (max 100 words) including material, features, and benefits
        3. "category": A single likely product category (e.g., Bedding, Home Decor, Kitchen, etc.)
        4. "brand": A likely brand name if visible (otherwise suggest a suitable one)
        5. "tags": An array of 5-7 relevant tags (each 1-3 words)
        6. "costPrice": Estimated wholesale/cost price in South African Rand (ZAR)
        7. "price": Suggested retail price in South African Rand (ZAR) with appropriate markup
        8. "marketResearch": Brief summary of current market prices for similar products in South Africa (3-4 sentences)
        
        The product name is: "${productName}"
        
        Important: Research current market prices for similar products in South Africa to provide realistic price estimates.
        Specifically look at what similar products cost in South African stores like Mr Price Home, Woolworths, @Home, and Takealot.
        
        Format the response as valid JSON only, with no additional text.`
      },
      {
        inlineData: { 
          data: imageData, 
          mimeType: 'image/png' 
        }
      }
    ]);
    
    // Get the response
    const response = await result.response;
    const responseText = response.text();
    
    // Parse JSON response
    try {
      // First, try to parse the response as-is
      const jsonResponse = JSON.parse(responseText);
      return {
        suggestedName: jsonResponse.name,
        suggestedDescription: jsonResponse.description,
        suggestedCategory: jsonResponse.category,
        suggestedBrand: jsonResponse.brand,
        suggestedTags: jsonResponse.tags,
        suggestedCostPrice: jsonResponse.costPrice ? Number(jsonResponse.costPrice) : undefined,
        suggestedPrice: jsonResponse.price ? Number(jsonResponse.price) : undefined
      };
    } catch (jsonError) {
      // If direct parsing fails, try to extract JSON from the text
      const jsonMatch = responseText.match(/\{[\s\S]*\}/);
      if (jsonMatch) {
        const jsonStr = jsonMatch[0];
        try {
          const extractedJson = JSON.parse(jsonStr);
          return {
            suggestedName: extractedJson.name,
            suggestedDescription: extractedJson.description,
            suggestedCategory: extractedJson.category,
            suggestedBrand: extractedJson.brand,
            suggestedTags: extractedJson.tags,
            suggestedCostPrice: extractedJson.costPrice ? Number(extractedJson.costPrice) : undefined,
            suggestedPrice: extractedJson.price ? Number(extractedJson.price) : undefined
          };
        } catch (extractError) {
          console.error('Failed to parse extracted JSON:', extractError);
          throw new Error('Failed to parse extracted JSON');
        }
      } else {
        console.error('No valid JSON found in response');
        throw new Error('No valid JSON found in response');
      }
    }
  } catch (error) {
    console.error('Product analysis failed:', error);
    throw new Error('Failed to analyze product image: ' + (error instanceof Error ? error.message : 'Unknown error'));
  }
}