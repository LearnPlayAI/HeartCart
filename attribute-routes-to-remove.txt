// These are all the attribute-related routes that need to be removed

// CATEGORY ATTRIBUTE ROUTES
app.get("/api/category-attributes/:id", handleErrors(async (req: Request, res: Response) => {
  const attributeId = parseInt(req.params.id);
  const attribute = await storage.getCategoryAttributeById(attributeId);
  if (!attribute) {
    return res.status(404).json({ message: "Attribute not found" });
  }
  res.json(attribute);
}));

app.post("/api/category-attributes", isAuthenticated, handleErrors(async (req: Request, res: Response) => {
  const user = req.user as any;
  
  // Check if user is admin
  if (user.role !== 'admin') {
    return res.status(403).json({ message: "Only administrators can create category attributes" });
  }
  
  const attribute = await storage.createCategoryAttribute(req.body);
  res.status(201).json(attribute);
}));

app.put("/api/category-attributes/:id", isAuthenticated, handleErrors(async (req: Request, res: Response) => {
  const user = req.user as any;
  
  // Check if user is admin
  if (user.role !== 'admin') {
    return res.status(403).json({ message: "Only administrators can update category attributes" });
  }
  
  const attributeId = parseInt(req.params.id);
  const attribute = await storage.updateCategoryAttribute(attributeId, req.body);
  if (!attribute) {
    return res.status(404).json({ message: "Attribute not found" });
  }
  res.json(attribute);
}));

app.delete("/api/category-attributes/:id", isAuthenticated, handleErrors(async (req: Request, res: Response) => {
  const user = req.user as any;
  
  // Check if user is admin
  if (user.role !== 'admin') {
    return res.status(403).json({ message: "Only administrators can delete category attributes" });
  }
  
  const attributeId = parseInt(req.params.id);
  const success = await storage.deleteCategoryAttribute(attributeId);
  res.json({ success });
}));

// CATEGORY ATTRIBUTE OPTIONS ROUTES
app.get("/api/category-attributes/:attributeId/options", handleErrors(async (req: Request, res: Response) => {
  const attributeId = parseInt(req.params.attributeId);
  const options = await storage.getCategoryAttributeOptions(attributeId);
  res.json(options);
}));

// Debug route for testing camelCase naming standardization
app.get("/api/debug/attribute-naming", handleErrors(async (req: Request, res: Response) => {
  const attributes = await storage.getCategoryAttributes(1);
    
  const options = attributes.length > 0 ? 
    await storage.getCategoryAttributeOptions(attributes[0].id) : [];
  
  res.json({
    attributeExample: attributes[0] || null,
    optionsExample: options.slice(0, 3) || []
  });
}));

app.post("/api/category-attribute-options", isAuthenticated, handleErrors(async (req: Request, res: Response) => {
  const user = req.user as any;
  
  // Check if user is admin
  if (user.role !== 'admin') {
    return res.status(403).json({ message: "Only administrators can create attribute options" });
  }
  
  const option = await storage.createCategoryAttributeOption(req.body);
  res.status(201).json(option);
}));

app.put("/api/category-attribute-options/:id", isAuthenticated, handleErrors(async (req: Request, res: Response) => {
  const user = req.user as any;
  
  // Check if user is admin
  if (user.role !== 'admin') {
    return res.status(403).json({ message: "Only administrators can update attribute options" });
  }
  
  const optionId = parseInt(req.params.id);
  const option = await storage.updateCategoryAttributeOption(optionId, req.body);
  if (!option) {
    return res.status(404).json({ message: "Option not found" });
  }
  res.json(option);
}));

app.delete("/api/category-attribute-options/:id", isAuthenticated, handleErrors(async (req: Request, res: Response) => {
  const user = req.user as any;
  
  // Check if user is admin
  if (user.role !== 'admin') {
    return res.status(403).json({ message: "Only administrators can delete attribute options" });
  }
  
  const optionId = parseInt(req.params.id);
  const success = await storage.deleteCategoryAttributeOption(optionId);
  res.json({ success });
}));

// Product Attributes for Category route
app.get("/api/products/attributes-for-category/:categoryId", handleErrors(async (req: Request, res: Response) => {
  const categoryId = parseInt(req.params.categoryId);
  
  // Validate categoryId is a number
  if (isNaN(categoryId)) {
    res.status(400).json({ message: "Invalid category ID" });
    return;
  }
  
  const user = req.user as any;
  const isAdmin = user && user.role === 'admin';
  
  const options = { 
    includeInactive: isAdmin, 
    includeCategoryInactive: isAdmin 
  };
  
  // Get all products in this category
  const products = await storage.getProductsByCategory(categoryId, undefined, undefined, options);
  
  // Get all attributes for this category
  const categoryAttributes = await storage.getCategoryAttributes(categoryId);
  
  // Create a lookup map for attribute names by ID
  const attributeNamesById: Record<number, string> = {};
  for (const attr of categoryAttributes) {
    attributeNamesById[attr.id] = attr.name;
  }
  
  // Get all attributes for these products
  const result = [];
  
  for (const product of products) {
    // Get product attribute values
    const attributeValues = await storage.getProductAttributeValues(product.id);
    
    // Format attribute values by attribute name
    const attributesByName: Record<string, string[]> = {};
    
    for (const attrValue of attributeValues) {
      const attributeName = attributeNamesById[attrValue.attributeId];
      if (attributeName) {
        if (!attributesByName[attributeName]) {
          attributesByName[attributeName] = [];
        }
        attributesByName[attributeName].push(attrValue.value);
      }
    }
    
    result.push({
      productId: product.id,
      attributes: attributesByName
    });
  }
  
  res.json(result);
}));

// PRODUCT ATTRIBUTE VALUE ROUTES
app.get("/api/products/:productId/attribute-values", handleErrors(async (req: Request, res: Response) => {
  const productId = parseInt(req.params.productId);
  const attributeValues = await storage.getProductAttributeValues(productId);
  res.json(attributeValues);
}));

app.post("/api/product-attribute-values", isAuthenticated, handleErrors(async (req: Request, res: Response) => {
  const user = req.user as any;
  
  // Check if user is admin
  if (user.role !== 'admin') {
    return res.status(403).json({ message: "Only administrators can create attribute values" });
  }
  
  const attributeValue = await storage.createProductAttributeValue(req.body);
  res.status(201).json(attributeValue);
}));

app.put("/api/product-attribute-values/:id", isAuthenticated, handleErrors(async (req: Request, res: Response) => {
  const user = req.user as any;
  
  // Check if user is admin
  if (user.role !== 'admin') {
    return res.status(403).json({ message: "Only administrators can update attribute values" });
  }
  
  const attributeValueId = parseInt(req.params.id);
  const attributeValue = await storage.updateProductAttributeValue(attributeValueId, req.body);
  if (!attributeValue) {
    return res.status(404).json({ message: "Attribute value not found" });
  }
  res.json(attributeValue);
}));

app.delete("/api/product-attribute-values/:id", isAuthenticated, handleErrors(async (req: Request, res: Response) => {
  const user = req.user as any;
  
  // Check if user is admin
  if (user.role !== 'admin') {
    return res.status(403).json({ message: "Only administrators can delete attribute values" });
  }
  
  const attributeValueId = parseInt(req.params.id);
  const success = await storage.deleteProductAttributeValue(attributeValueId);
  res.json({ success });
}));

// PRODUCT ATTRIBUTE COMBINATION ROUTES
app.get("/api/products/:productId/attribute-combinations", handleErrors(async (req: Request, res: Response) => {
  const productId = parseInt(req.params.productId);
  const combinations = await storage.getProductAttributeCombinations(productId);
  res.json(combinations);
}));

app.get("/api/products/:productId/attribute-combinations/:hash", handleErrors(async (req: Request, res: Response) => {
  const { productId, hash } = req.params;
  const combination = await storage.getProductAttributeCombinationByHash(parseInt(productId), hash);
  
  if (!combination) {
    return res.status(404).json({ message: "Attribute combination not found" });
  }
  
  res.json(combination);
}));

app.post("/api/product-attribute-combinations", isAuthenticated, handleErrors(async (req: Request, res: Response) => {
  const user = req.user as any;
  
  // Check if user is admin
  if (user.role !== 'admin') {
    return res.status(403).json({ message: "Only administrators can create attribute combinations" });
  }
  
  const combination = await storage.createProductAttributeCombination(req.body);
  res.status(201).json(combination);
}));

app.put("/api/product-attribute-combinations/:id", isAuthenticated, handleErrors(async (req: Request, res: Response) => {
  const user = req.user as any;
  
  // Check if user is admin
  if (user.role !== 'admin') {
    return res.status(403).json({ message: "Only administrators can update attribute combinations" });
  }
  
  const combinationId = parseInt(req.params.id);
  const combination = await storage.updateProductAttributeCombination(combinationId, req.body);
  if (!combination) {
    return res.status(404).json({ message: "Attribute combination not found" });
  }
  res.json(combination);
}));

app.delete("/api/product-attribute-combinations/:id", isAuthenticated, handleErrors(async (req: Request, res: Response) => {
  const user = req.user as any;
  
  // Check if user is admin
  if (user.role !== 'admin') {
    return res.status(403).json({ message: "Only administrators can delete attribute combinations" });
  }
  
  const combinationId = parseInt(req.params.id);
  const success = await storage.deleteProductAttributeCombination(combinationId);
  res.json({ success });
}));

// GLOBAL ATTRIBUTES ROUTES
app.get("/api/global-attributes", handleErrors(async (req: Request, res: Response) => {
  const attributes = await storage.getAllGlobalAttributes();
  res.json(attributes);
}));

app.get("/api/global-attributes/:id", handleErrors(async (req: Request, res: Response) => {
  const attributeId = parseInt(req.params.id);
  const attribute = await storage.getGlobalAttributeById(attributeId);
  if (!attribute) {
    return res.status(404).json({ message: "Attribute not found" });
  }
  res.json(attribute);
}));

app.post("/api/global-attributes", isAuthenticated, handleErrors(async (req: Request, res: Response) => {
  const user = req.user as any;
  
  // Check if user is admin
  if (user.role !== 'admin') {
    return res.status(403).json({ message: "Only administrators can create global attributes" });
  }
  
  const attributeData = insertGlobalAttributeSchema.parse(req.body);
  const attribute = await storage.createGlobalAttribute(attributeData);
  res.status(201).json(attribute);
}));

app.put("/api/global-attributes/:id", isAuthenticated, handleErrors(async (req: Request, res: Response) => {
  const user = req.user as any;
  
  // Check if user is admin
  if (user.role !== 'admin') {
    return res.status(403).json({ message: "Only administrators can update global attributes" });
  }
  
  const attributeId = parseInt(req.params.id);
  const attributeData = insertGlobalAttributeSchema.partial().parse(req.body);
  const attribute = await storage.updateGlobalAttribute(attributeId, attributeData);
  if (!attribute) {
    return res.status(404).json({ message: "Attribute not found" });
  }
  res.json(attribute);
}));

app.delete("/api/global-attributes/:id", isAuthenticated, handleErrors(async (req: Request, res: Response) => {
  const user = req.user as any;
  
  // Check if user is admin
  if (user.role !== 'admin') {
    return res.status(403).json({ message: "Only administrators can delete global attributes" });
  }
  
  const attributeId = parseInt(req.params.id);
  const success = await storage.deleteGlobalAttribute(attributeId);
  if (!success) {
    return res.status(404).json({ message: "Attribute not found or could not be deleted" });
  }
  res.json({ success });
}));

// GLOBAL ATTRIBUTE OPTIONS ROUTES
app.get("/api/global-attributes/:attributeId/options", handleErrors(async (req: Request, res: Response) => {
  const attributeId = parseInt(req.params.attributeId);
  const options = await storage.getGlobalAttributeOptions(attributeId);
  res.json(options);
}));

app.post("/api/global-attribute-options", isAuthenticated, handleErrors(async (req: Request, res: Response) => {
  const user = req.user as any;
  
  // Check if user is admin
  if (user.role !== 'admin') {
    return res.status(403).json({ message: "Only administrators can create attribute options" });
  }
  
  const optionData = insertGlobalAttributeOptionSchema.parse(req.body);
  const option = await storage.createGlobalAttributeOption(optionData);
  res.status(201).json(option);
}));

app.put("/api/global-attribute-options/:id", isAuthenticated, handleErrors(async (req: Request, res: Response) => {
  const user = req.user as any;
  
  // Check if user is admin
  if (user.role !== 'admin') {
    return res.status(403).json({ message: "Only administrators can update attribute options" });
  }
  
  const optionId = parseInt(req.params.id);
  const optionData = insertGlobalAttributeOptionSchema.partial().parse(req.body);
  const option = await storage.updateGlobalAttributeOption(optionId, optionData);
  if (!option) {
    return res.status(404).json({ message: "Option not found" });
  }
  res.json(option);
}));

app.delete("/api/global-attribute-options/:id", isAuthenticated, handleErrors(async (req: Request, res: Response) => {
  const user = req.user as any;
  
  // Check if user is admin
  if (user.role !== 'admin') {
    return res.status(403).json({ message: "Only administrators can delete attribute options" });
  }
  
  const optionId = parseInt(req.params.id);
  const success = await storage.deleteGlobalAttributeOption(optionId);
  if (!success) {
    return res.status(404).json({ message: "Option not found or could not be deleted" });
  }
  res.json({ success });
}));

// PRODUCT GLOBAL ATTRIBUTE ROUTES
app.get("/api/products/:productId/global-attributes", handleErrors(async (req: Request, res: Response) => {
  const productId = parseInt(req.params.productId);
  const attributes = await storage.getProductGlobalAttributes(productId);
  res.json(attributes);
}));

app.get("/api/products/:productId/global-attributes-with-options", handleErrors(async (req: Request, res: Response) => {
  const productId = parseInt(req.params.productId);
  const attributesWithOptions = await storage.getGlobalAttributesWithOptionsForProduct(productId);
  res.json(attributesWithOptions);
}));

app.post("/api/products/:productId/global-attributes", isAuthenticated, handleErrors(async (req: Request, res: Response) => {
  const user = req.user as any;
  
  // Check if user is admin
  if (user.role !== 'admin') {
    return res.status(403).json({ message: "Only administrators can add global attributes to products" });
  }
  
  const productId = parseInt(req.params.productId);
  const { attributeId } = req.body;
  
  if (!attributeId) {
    return res.status(400).json({ message: "Attribute ID is required" });
  }
  
  const productAttribute = await storage.addGlobalAttributeToProduct(productId, attributeId);
  res.status(201).json(productAttribute);
}));

app.delete("/api/products/:productId/global-attributes/:attributeId", isAuthenticated, handleErrors(async (req: Request, res: Response) => {
  const user = req.user as any;
  
  // Check if user is admin
  if (user.role !== 'admin') {
    return res.status(403).json({ message: "Only administrators can remove global attributes from products" });
  }
  
  const productId = parseInt(req.params.productId);
  const attributeId = parseInt(req.params.attributeId);
  const success = await storage.removeGlobalAttributeFromProduct(productId, attributeId);
  
  if (!success) {
    return res.status(404).json({ message: "Product-attribute association not found" });
  }
  
  res.json({ success });
}));

// PRODUCT GLOBAL ATTRIBUTE OPTION ROUTES
app.post("/api/product-global-attributes/:productAttributeId/options", isAuthenticated, handleErrors(async (req: Request, res: Response) => {
  const user = req.user as any;
  
  // Check if user is admin
  if (user.role !== 'admin') {
    return res.status(403).json({ message: "Only administrators can add options to product attributes" });
  }
  
  const productAttributeId = parseInt(req.params.productAttributeId);
  const { optionId } = req.body;
  
  if (!optionId) {
    return res.status(400).json({ message: "Option ID is required" });
  }
  
  const productOption = await storage.addGlobalAttributeOptionToProduct(productAttributeId, optionId);
  res.status(201).json(productOption);
}));

app.delete("/api/product-global-attributes/:productAttributeId/options/:optionId", isAuthenticated, handleErrors(async (req: Request, res: Response) => {
  const user = req.user as any;
  
  // Check if user is admin
  if (user.role !== 'admin') {
    return res.status(403).json({ message: "Only administrators can remove options from product attributes" });
  }
  
  const productAttributeId = parseInt(req.params.productAttributeId);
  const optionId = parseInt(req.params.optionId);
  const success = await storage.removeGlobalAttributeOptionFromProduct(productAttributeId, optionId);
  
  if (!success) {
    return res.status(404).json({ message: "Product attribute option not found" });
  }
  
  res.json({ success });
}));