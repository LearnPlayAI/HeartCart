
# Social Media Sharing Implementation Guide

This guide provides a complete implementation for Facebook and WhatsApp sharing functionality, including Open Graph meta tags, social preview generation, and share dialog components.

## Table of Contents

1. [Overview](#overview)
2. [Backend Implementation](#backend-implementation)
3. [Frontend Implementation](#frontend-implementation)
4. [Open Graph Meta Tags](#open-graph-meta-tags)
5. [Social Preview Service](#social-preview-service)
6. [Share Dialog Component](#share-dialog-component)
7. [Testing and Troubleshooting](#testing-and-troubleshooting)

## Overview

The social sharing system consists of three main components:

1. **Social Preview Service** - Generates HTML pages with Open Graph meta tags for social crawlers
2. **Share Dialog Component** - Provides native and web-based sharing options
3. **Meta Tag Generation** - Dynamic Open Graph tags for rich social media previews

## Backend Implementation

### 1. Social Preview Service

Create `server/socialPreview.ts`:

```typescript
import { Request, Response } from 'express';
import { eq, and } from 'drizzle-orm';
import { products, users, categories, addresses } from '../shared/schema';
import { unifiedDataManager, createDataContext } from './unifiedDataManager';
import { objectStore } from './objectStore';

interface ProductSocialData {
  id: number;
  title: string;
  description: string;
  price: number;
  condition: string;
  location: string;
  imageUrl?: string;
  imageBase64?: string;
  sellerName: string;
  categoryName: string;
}

/**
 * Fetch product data with optimized image for social sharing
 */
async function getProductSocialData(productId: number): Promise<ProductSocialData | null> {
  try {
    // Create proper data context for production schema access
    const dataContext = createDataContext({
      environment: 'production',
      isAuthenticated: false,
      userEmail: undefined
    });

    const db = await unifiedDataManager.getConnection(dataContext);
    
    // Fetch product with seller, category, and address information
    const productData = await db
      .select({
        product: products,
        seller: {
          id: users.id,
          username: users.username,
          fullName: users.fullName
        },
        category: {
          id: categories.id,
          name: categories.name
        },
        address: {
          city: addresses.city,
          province: addresses.province
        }
      })
      .from(products)
      .leftJoin(users, eq(products.sellerId, users.id))
      .leftJoin(categories, eq(products.categoryId, categories.id))
      .leftJoin(addresses, and(eq(addresses.userId, users.id), eq(addresses.isMain, true)))
      .where(eq(products.id, productId))
      .limit(1);

    if (!productData.length) {
      return null;
    }

    const { product, seller, category, address } = productData[0];

    // Get optimized product image
    let imageUrl: string | undefined;
    let imageBase64: string | undefined;
    
    if (product.image1ObjectKey) {
      try {
        // Use API file route for consistent access
        imageUrl = `/api/files/${product.image1ObjectKey}`;
        
        // Get base64 data for embedding (fallback)
        const imageData = await objectStore.getFileAsBuffer(product.image1ObjectKey);
        if (imageData.data) {
          const base64Data = imageData.data.toString('base64');
          const mimeType = imageData.contentType || 'image/jpeg';
          imageBase64 = `data:${mimeType};base64,${base64Data}`;
        }
      } catch (error) {
        console.warn(`Failed to get image for product ${productId}:`, error);
      }
    }

    // Construct location from address data
    const location = address?.city && address?.province 
      ? `${address.city}, ${address.province}` 
      : address?.city || address?.province || 'South Africa';

    return {
      id: product.id,
      title: product.title,
      description: product.description,
      price: product.price,
      condition: product.condition,
      location,
      imageUrl,
      imageBase64,
      sellerName: seller?.fullName || seller?.username || 'Seller',
      categoryName: category?.name || 'General'
    };
  } catch (error) {
    console.error(`Error fetching social data for product ${productId}:`, error);
    return null;
  }
}

/**
 * Generate HTML with Open Graph meta tags for social sharing
 */
function generateProductSocialHTML(product: ProductSocialData): string {
  const baseUrl = 'https://yourdomain.com'; // Replace with your domain
  const productUrl = `${baseUrl}/product/${product.id}`;
  
  // Optimize image URL for social sharing (Facebook prefers 1200x630)
  // Ensure absolute URLs for Facebook crawler
  const socialImageUrl = product.imageUrl 
    ? `${baseUrl}${product.imageUrl}`
    : `${baseUrl}/api/product-image/${product.id}`;
  
  // Create optimized meta description
  const metaDescription = `${product.title} - R${product.price.toLocaleString()} | ${product.condition} condition | ${product.location} | Sold by ${product.sellerName} on YourSite - South Africa's premier marketplace.`;
  
  // Truncate description to Facebook's 300 character limit
  const truncatedDescription = metaDescription.length > 300 
    ? metaDescription.substring(0, 297) + '...'
    : metaDescription;

  return `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- Basic Meta Tags -->
  <title>${product.title} - R${product.price.toLocaleString()} | YourSite</title>
  <meta name="description" content="${truncatedDescription}">
  
  <!-- Open Graph Meta Tags for Facebook -->
  <meta property="og:type" content="product">
  <meta property="og:title" content="${product.title} - R${product.price.toLocaleString()}">
  <meta property="og:description" content="${truncatedDescription}">
  <meta property="og:url" content="${productUrl}">
  <meta property="og:image" content="${socialImageUrl}">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:image:alt" content="${product.title}">
  <meta property="og:site_name" content="YourSite">
  <meta property="og:locale" content="en_ZA">
  
  <!-- Product-specific Open Graph -->
  <meta property="product:price:amount" content="${product.price}">
  <meta property="product:price:currency" content="ZAR">
  <meta property="product:availability" content="in stock">
  <meta property="product:condition" content="${product.condition.toLowerCase()}">
  <meta property="product:category" content="${product.categoryName}">
  
  <!-- Twitter Card Meta Tags -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="${product.title} - R${product.price.toLocaleString()}">
  <meta name="twitter:description" content="${truncatedDescription}">
  <meta name="twitter:image" content="${socialImageUrl}">
  <meta name="twitter:image:alt" content="${product.title}">
  
  <!-- WhatsApp specific (uses Open Graph) -->
  <meta property="og:image:type" content="image/jpeg">
  
  <!-- Redirect to actual product page -->
  <script>
    // Only redirect if this is not a crawler/bot
    if (!navigator.userAgent.match(/facebookexternalhit|WhatsApp|Twitterbot|LinkedInBot/i)) {
      window.location.replace('${productUrl}');
    }
  </script>
</head>
<body>
  <!-- Fallback content for crawlers -->
  <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
    <h1>${product.title}</h1>
    <div style="font-size: 24px; color: #2563eb; font-weight: bold; margin: 10px 0;">
      R${product.price.toLocaleString()}
    </div>
    ${product.imageUrl ? `<img src="${socialImageUrl}" alt="${product.title}" style="max-width: 100%; height: auto; border-radius: 8px;">` : ''}
    <p style="margin: 15px 0; line-height: 1.5;">${product.description}</p>
    <div style="margin: 10px 0;">
      <strong>Condition:</strong> ${product.condition}<br>
      <strong>Location:</strong> ${product.location}<br>
      <strong>Seller:</strong> ${product.sellerName}<br>
      <strong>Category:</strong> ${product.categoryName}
    </div>
    <a href="${productUrl}" style="display: inline-block; background: #2563eb; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; margin-top: 20px;">
      View Full Details
    </a>
  </div>
</body>
</html>`;
}

/**
 * Handle social preview request for product
 */
export async function handleProductSocialPreview(req: Request, res: Response): Promise<void> {
  try {
    const productId = parseInt(req.params.id);
    
    if (isNaN(productId)) {
      res.status(400).json({ error: 'Invalid product ID' });
      return;
    }

    // Fetch product data
    const productData = await getProductSocialData(productId);
    
    if (!productData) {
      res.status(404).json({ error: 'Product not found' });
      return;
    }

    // Generate and return HTML with Open Graph meta tags
    const socialHTML = generateProductSocialHTML(productData);
    
    res.setHeader('Content-Type', 'text/html; charset=utf-8');
    res.setHeader('Cache-Control', 'public, max-age=3600'); // Cache for 1 hour
    res.send(socialHTML);
    
  } catch (error) {
    console.error('Error generating product social preview:', error);
    res.status(500).json({ error: 'Internal server error' });
  }
}

/**
 * Serve optimized product image for social sharing
 */
export async function handleProductImage(req: Request, res: Response): Promise<void> {
  try {
    const productId = parseInt(req.params.id);
    
    if (isNaN(productId)) {
      res.status(400).json({ error: 'Invalid product ID' });
      return;
    }

    // Get product image key using proper data context
    const dataContext = createDataContext({
      environment: 'production',
      isAuthenticated: false,
      userEmail: undefined
    });

    const db = await unifiedDataManager.getConnection(dataContext);
    
    const productData = await db
      .select({ image1ObjectKey: products.image1ObjectKey })
      .from(products)
      .where(eq(products.id, productId))
      .limit(1);

    if (!productData.length || !productData[0].image1ObjectKey) {
      res.status(404).json({ error: 'Product image not found' });
      return;
    }

    // Get image from object store
    const imageData = await objectStore.getFileAsBuffer(productData[0].image1ObjectKey);
    
    if (!imageData.data) {
      res.status(404).json({ error: 'Image data not found' });
      return;
    }

    // Set appropriate headers
    res.setHeader('Content-Type', imageData.contentType || 'image/jpeg');
    res.setHeader('Cache-Control', 'public, max-age=86400'); // Cache for 24 hours
    res.setHeader('Content-Length', imageData.data.length);
    
    res.send(imageData.data);
    
  } catch (error) {
    console.error('Error serving product image:', error);
    res.status(500).json({ error: 'Internal server error' });
  }
}
```

### 2. Social Preview Routes

Add to your main routes file:

```typescript
import { handleProductSocialPreview, handleProductImage } from '../socialPreview';

// Social preview routes
app.get('/api/social-preview/product/:id', handleProductSocialPreview);
app.get('/api/product-image/:id', handleProductImage);
```

## Frontend Implementation

### Share Dialog Component

Create `src/components/ShareProductDialog.tsx`:

```typescript
import { useState } from "react";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Share2, Copy, MessageCircle, Mail, Send, Check } from "lucide-react";
import { useToast } from "@/hooks/use-toast";
import { FaFacebook, FaTwitter } from "react-icons/fa";

interface ShareProductDialogProps {
  productId: number;
  productTitle: string;
  productPrice: number;
  productImage?: string;
  trigger?: React.ReactNode;
}

export default function ShareProductDialog({ 
  productId, 
  productTitle, 
  productPrice, 
  productImage,
  trigger 
}: ShareProductDialogProps) {
  const [open, setOpen] = useState(false);
  const [copied, setCopied] = useState(false);
  const { toast } = useToast();

  // Generate product URL - always use production domain for sharing
  const productUrl = `https://yourdomain.com/product/${productId}`;
  
  // For WhatsApp sharing, use social preview URL to ensure rich card display
  const socialPreviewUrl = `https://yourdomain.com/api/social-preview/product/${productId}`;
  
  // Format rich sharing text for WhatsApp and other platforms
  const shareText = `ðŸŽ¯ *${productTitle}* ðŸŽ¯

ðŸ’° *Price: R${productPrice.toLocaleString()}*
ðŸ›ï¸ Condition: ${productImage ? 'Great condition with photos' : 'Available now'}
ðŸ‡¿ðŸ‡¦ Connect with South Africa's community

ðŸ¤ Bringing people together ðŸŽ¯ Trusted community ðŸ“ Local connections

ðŸ‘† Tap to view full details and photos`;

  const shareData = {
    title: `${productTitle} - R${productPrice.toLocaleString()} | YourSite.com`,
    text: shareText,
    url: productUrl,
  };

  // Check if native share is available
  const canShare = 'share' in navigator;

  const handleNativeShare = async () => {
    if (canShare) {
      try {
        await navigator.share(shareData);
        setOpen(false);
        toast({
          title: "Shared successfully",
          description: "Thank you for sharing this product!",
        });
      } catch (error) {
        // User cancelled or error occurred
        if (error instanceof Error && error.name !== 'AbortError') {
          toast({
            title: "Share failed",
            description: "Please try copying the link instead.",
            variant: "destructive",
          });
        }
      }
    }
  };

  const handleCopyLink = async () => {
    try {
      await navigator.clipboard.writeText(productUrl);
      setCopied(true);
      setTimeout(() => setCopied(false), 2000);
      toast({
        title: "Link copied!",
        description: "Product link has been copied to your clipboard.",
      });
    } catch (error) {
      toast({
        title: "Copy failed",
        description: "Please manually copy the URL from your browser.",
        variant: "destructive",
      });
    }
  };

  const handleWhatsAppShare = () => {
    // Use social preview URL for rich WhatsApp card display
    const whatsappMessage = `${shareText}

ðŸ”— ${socialPreviewUrl}`;

    const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(whatsappMessage)}`;
    window.open(whatsappUrl, '_blank');
    setOpen(false);
  };

  const handleFacebookShare = () => {
    // Use regular product URL - Facebook will crawl for Open Graph tags
    const facebookUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(productUrl)}`;
    window.open(facebookUrl, '_blank', 'width=600,height=400');
    setOpen(false);
  };

  const handleTwitterShare = () => {
    const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}&url=${encodeURIComponent(productUrl)}`;
    window.open(twitterUrl, '_blank', 'width=600,height=400');
    setOpen(false);
  };

  const handleEmailShare = () => {
    const subject = encodeURIComponent(`Check out this ${productTitle} on YourSite`);
    const body = encodeURIComponent(`Hi,\n\nI found this interesting product on YourSite that you might like:\n\n${productTitle}\nPrice: R${productPrice.toLocaleString()}\n\nView it here: ${productUrl}\n\nBest regards`);
    const mailtoUrl = `mailto:?subject=${subject}&body=${body}`;
    window.open(mailtoUrl);
    setOpen(false);
  };

  const handleSMSShare = () => {
    const smsUrl = `sms:?body=${encodeURIComponent(`${shareText} ${productUrl}`)}`;
    window.open(smsUrl);
    setOpen(false);
  };

  return (
    <Dialog open={open} onOpenChange={setOpen}>
      <DialogTrigger asChild>
        {trigger || (
          <Button variant="outline" size="lg">
            <Share2 className="w-5 h-5" />
          </Button>
        )}
      </DialogTrigger>
      
      <DialogContent className="sm:max-w-md max-w-[95vw] mx-auto" aria-describedby="share-description">
        <DialogHeader>
          <DialogTitle className="flex items-center gap-2">
            <Share2 className="w-5 h-5" />
            Share this product
          </DialogTitle>
          <p id="share-description" className="text-sm text-muted-foreground sr-only">
            Share this product via social media, messaging apps, or copy the link to share with others.
          </p>
        </DialogHeader>
        
        <div className="space-y-4">
          {/* Product Preview */}
          <div className="flex items-center gap-3 p-3 bg-gray-50 dark:bg-gray-800 rounded-lg">
            {productImage && (
              <img 
                src={productImage} 
                alt={productTitle}
                className="w-12 h-12 object-cover rounded"
                onError={(e) => {
                  e.currentTarget.style.display = 'none';
                }}
              />
            )}
            <div className="flex-1 min-w-0">
              <p className="font-medium text-sm truncate">{productTitle}</p>
              <p className="text-green-600 font-semibold">R{productPrice.toLocaleString()}</p>
            </div>
          </div>

          {/* Native Share Button (if available) */}
          {canShare && (
            <Button 
              onClick={handleNativeShare}
              className="w-full bg-blue-600 hover:bg-blue-700 text-white"
            >
              <Share2 className="w-4 h-4 mr-2" />
              Share via device
            </Button>
          )}

          {/* Share Options Grid */}
          <div className="grid grid-cols-2 gap-3">
            {/* Copy Link */}
            <Button
              variant="outline"
              onClick={handleCopyLink}
              className="flex items-center justify-center gap-2 h-12"
            >
              {copied ? <Check className="w-4 h-4" /> : <Copy className="w-4 h-4" />}
              <span className="text-sm">Copy Link</span>
            </Button>

            {/* WhatsApp */}
            <Button
              variant="outline"
              onClick={handleWhatsAppShare}
              className="flex items-center justify-center gap-2 h-12 text-green-600 border-green-200 hover:bg-green-50"
            >
              <MessageCircle className="w-4 h-4" />
              <span className="text-sm">WhatsApp</span>
            </Button>

            {/* Facebook */}
            <Button
              variant="outline"
              onClick={handleFacebookShare}
              className="flex items-center justify-center gap-2 h-12 text-blue-600 border-blue-200 hover:bg-blue-50"
            >
              <FaFacebook className="w-4 h-4" />
              <span className="text-sm">Facebook</span>
            </Button>

            {/* Twitter */}
            <Button
              variant="outline"
              onClick={handleTwitterShare}
              className="flex items-center justify-center gap-2 h-12 text-blue-400 border-blue-200 hover:bg-blue-50"
            >
              <FaTwitter className="w-4 h-4" />
              <span className="text-sm">Twitter</span>
            </Button>

            {/* Email */}
            <Button
              variant="outline"
              onClick={handleEmailShare}
              className="flex items-center justify-center gap-2 h-12"
            >
              <Mail className="w-4 h-4" />
              <span className="text-sm">Email</span>
            </Button>

            {/* SMS */}
            <Button
              variant="outline"
              onClick={handleSMSShare}
              className="flex items-center justify-center gap-2 h-12"
            >
              <Send className="w-4 h-4" />
              <span className="text-sm">SMS</span>
            </Button>
          </div>

          {/* URL Display */}
          <div className="pt-2 border-t">
            <p className="text-xs text-muted-foreground mb-2">Product URL:</p>
            <div className="flex items-center gap-2 p-2 bg-gray-50 dark:bg-gray-800 rounded text-xs break-all">
              <span className="flex-1">{productUrl}</span>
            </div>
          </div>
        </div>
      </DialogContent>
    </Dialog>
  );
}
```

## Open Graph Meta Tags

### For Product Pages

Add these meta tags to your product page template:

```html
<!-- Basic Meta Tags -->
<title>{product.title} - R{product.price.toLocaleString()} | YourSite</title>
<meta name="description" content="{product.description}" />

<!-- Open Graph Meta Tags -->
<meta property="og:type" content="product" />
<meta property="og:title" content="{product.title} - R{product.price.toLocaleString()}" />
<meta property="og:description" content="{product.description}" />
<meta property="og:url" content="https://yourdomain.com/product/{product.id}" />
<meta property="og:image" content="https://yourdomain.com{product.imageUrl}" />
<meta property="og:image:width" content="1200" />
<meta property="og:image:height" content="630" />
<meta property="og:image:alt" content="{product.title}" />
<meta property="og:site_name" content="YourSite" />

<!-- Product-specific Open Graph -->
<meta property="product:price:amount" content="{product.price}" />
<meta property="product:price:currency" content="ZAR" />
<meta property="product:availability" content="in stock" />
<meta property="product:condition" content="{product.condition.toLowerCase()}" />

<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content="{product.title} - R{product.price.toLocaleString()}" />
<meta name="twitter:description" content="{product.description}" />
<meta name="twitter:image" content="https://yourdomain.com{product.imageUrl}" />
```

## Testing and Troubleshooting

### 1. Test Social Previews

**Facebook Sharing Debugger:**
- Visit: https://developers.facebook.com/tools/debug/
- Enter your social preview URL: `https://yourdomain.com/api/social-preview/product/123`
- Click "Debug" to see how Facebook sees your page

**WhatsApp Preview Test:**
- Send the social preview URL to yourself on WhatsApp
- Check that the rich preview card appears with image, title, and description

### 2. Common Issues and Solutions

**Issue: Facebook not showing updated preview**
- Solution: Use Facebook's Sharing Debugger to scrape fresh content
- Facebook caches content, use "Scrape Again" button

**Issue: WhatsApp not showing rich preview**
- Solution: Ensure you're using the social preview URL, not the direct product URL
- Check that Open Graph tags are properly formatted

**Issue: Images not loading in previews**
- Solution: Ensure image URLs are absolute (include https://domain.com)
- Check image file sizes (Facebook recommends 1200x630px)
- Verify images are publicly accessible

**Issue: Preview shows old/cached content**
- Solution: Implement cache-busting in social preview URLs
- Add version parameter: `/api/social-preview/product/123?v=timestamp`

### 3. Required Dependencies

Install these packages:

```bash
npm install react-icons lucide-react
```

### 4. Environment Configuration

Replace all instances of:
- `yourdomain.com` with your actual domain
- `YourSite` with your actual site name
- Customize the sharing text and branding

### 5. Performance Optimization

- Cache social preview HTML for 1 hour
- Optimize images for social sharing (1200x630px recommended)
- Use CDN for serving images if possible
- Implement lazy loading for share dialog

## Usage Example

```typescript
// In your product page component
import ShareProductDialog from '@/components/ShareProductDialog';

// Usage
<ShareProductDialog
  productId={product.id}
  productTitle={product.title}
  productPrice={product.price}
  productImage={product.imageUrl}
  trigger={
    <Button variant="outline">
      <Share2 className="w-4 h-4 mr-2" />
      Share
    </Button>
  }
/>
```

This implementation provides comprehensive social sharing functionality that works reliably across Facebook, WhatsApp, and other social platforms. The key to success is the combination of proper Open Graph meta tags, a dedicated social preview service, and platform-specific sharing URLs.
